name: Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Debug Secrets
        run: |
          echo "Checking for secret presence (not values):"
          echo "FIREBASE_API_KEY exists: ${{ secrets.FIREBASE_API_KEY != '' }}"
          echo "FIREBASE_AUTH_DOMAIN exists: ${{ secrets.FIREBASE_AUTH_DOMAIN != '' }}"
          echo "FIREBASE_PROJECT_ID exists: ${{ secrets.FIREBASE_PROJECT_ID != '' }}"
          echo "TWITCH_CLIENT_ID exists: ${{ secrets.TWITCH_CLIENT_ID != '' }}"

      - name: Create config files directly
        run: |
          # Create firebase-config.js from scratch
          cat > js/firebase-config.js << 'EOF'
          // Production Firebase Configuration
          function initializeFirebase() {
              try {
                  // Production Firebase configuration
                  const firebaseConfig = {
                      apiKey: "${{ secrets.FIREBASE_API_KEY }}",
                      authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
                      projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
                      storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
                      messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
                      appId: "${{ secrets.FIREBASE_APP_ID }}",
                      measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
                  };
                  
                  console.log('Initializing Firebase with project ID:', firebaseConfig.projectId);
                  
                  // Initialize Firebase
                  firebase.initializeApp(firebaseConfig);
                  
                  // Set up services
                  window.db = firebase.firestore();
                  window.auth = firebase.auth();
                  firebase.analytics();
                  
                  console.log('Firebase initialized successfully');
              } catch (error) {
                  console.error('Firebase initialization error:', error);
              }
          }

          // Initialize Firebase when the script loads
          initializeFirebase();
          EOF

          # Update auth.js for Twitch credentials
          sed -i "s/{{TWITCH_CLIENT_ID}}/\"${{ secrets.TWITCH_CLIENT_ID }}\"/g" js/auth.js
          sed -i "s/{{TWITCH_REDIRECT_URI}}/\"${{ secrets.TWITCH_REDIRECT_URI }}\"/g" js/auth.js

      - name: Display Updated Files (for debugging)
        run: |
          echo "=== First 10 lines of firebase-config.js ==="
          head -n 10 js/firebase-config.js
          echo "=== First few lines with credentials (sensitive parts masked) ==="
          grep -A5 "firebaseConfig" js/firebase-config.js | sed 's/\(apiKey: \)"[^"]*"/\1"***"/g'
          echo "=========================================="

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: .
          branch: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
